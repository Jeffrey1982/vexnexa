generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // runtime (can be Supabase pooler 6543)
  directUrl = env("DIRECT_URL") // migrations (direct 5432)
}

model User {
  id    String @id @default(cuid())
  email String @unique
  sites Site[]

  // Personal information
  firstName   String?
  lastName    String?
  company     String?
  jobTitle    String?
  phoneNumber String?
  website     String?
  country     String?

  // Marketing preferences
  marketingEmails   Boolean @default(false)
  productUpdates    Boolean @default(true)
  teamInvitations   Boolean @default(true)
  scanNotifications Boolean @default(true)
  weeklyReports     Boolean @default(false)

  // Profile completion
  profileCompleted Boolean @default(false)

  // Billing fields
  plan               Plan      @default(TRIAL) // TRIAL, STARTER, PRO, BUSINESS
  subscriptionStatus String    @default("trialing") // active, canceled, past_due, inactive
  trialEndsAt        DateTime?
  trialStartsAt      DateTime?
  trialOrigin        String? // "self-signup", "partner", "referral", "ad-campaign", etc.

  // Mollie koppelingen
  mollieCustomerId     String? @unique
  mollieSubscriptionId String? // actuele sub (1 actief tegelijk)

  // Add-ons (extra seats, scan packages)
  extraSeats Int     @default(0) // Additional team seats purchased
  addOns     AddOn[] // Scan packages and seat subscriptions

  usages     Usage[]
  whiteLabel WhiteLabel?
  portfolios Portfolio[]

  // Team collaboration
  ownedTeams      Team[]       @relation("TeamOwner")
  teamMemberships TeamMember[]
  sentInvites     TeamInvite[] @relation("InvitedBy")
  invitedBy       TeamMember[] @relation("InvitedByUser")

  // Issue tracking
  createdIssues    Issue[]         @relation("CreatedBy")
  assignedIssues   Issue[]         @relation("AssignedTo")
  assignedByIssues Issue[]         @relation("AssignedBy")
  resolvedIssues   Issue[]         @relation("ResolvedBy")
  issueComments    IssueComment[]
  issueActivities  IssueActivity[]

  // Manual audit tracking
  createdAudits    ManualAudit[]     @relation("AuditCreator")
  assignedAudits   ManualAudit[]     @relation("AuditAssignee")
  reviewedAudits   ManualAudit[]     @relation("AuditReviewer")
  auditTemplates   AuditTemplate[]
  testedAuditItems AuditItem[]
  auditAttachments AuditAttachment[]

  // Blog
  blogPosts BlogPost[]

  // Support tickets
  supportTickets        SupportTicket[]
  supportTicketMessages SupportTicketMessage[]

  // Admin role
  isAdmin    Boolean         @default(false)
  adminNotes AdminUserNote[] @relation("AdminNotes")

  // Notifications & Webhooks
  notifications    Notification[]
  webhookEndpoints WebhookEndpoint[]

  // Scheduled scans
  scheduledScans ScheduledScan[]

  // Accessibility Assurance subscriptions
  assuranceSubscriptions AssuranceSubscription[] @relation("AssuranceSubscriptions")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Site {
  id     String  @id @default(cuid())
  userId String
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  url    String
  pages  Page[]
  scans  Scan[]
  crawls Crawl[]

  // Portfolio association
  portfolioId String?
  portfolio   Portfolio? @relation(fields: [portfolioId], references: [id], onDelete: SetNull)

  // Team collaboration
  teams Team[] @relation("TeamSites")

  // Manual audits
  manualAudits ManualAudit[]

  // Scheduled scans
  scheduledScans ScheduledScan[]

  createdAt DateTime @default(now())

  @@unique([userId, url]) // enables where: { userId_url: { ... } }
  @@index([userId])
  @@index([portfolioId])
}

model Page {
  id           String   @id @default(cuid())
  siteId       String
  site         Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  url          String
  title        String?
  latestScanId String?
  scans        Scan[]
  createdAt    DateTime @default(now())

  @@unique([siteId, url]) // enables where: { siteId_url: { ... } }
  @@index([siteId])
}

model Scan {
  id     String @id @default(cuid())
  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // NEW: optional link to Page
  pageId String?
  page   Page?   @relation(fields: [pageId], references: [id], onDelete: SetNull)

  status    String
  score     Int?
  issues    Int?
  reportUrl String?

  // Issue tracking
  scanIssues Issue[]

  // Impact counts
  impactCritical Int @default(0)
  impactSerious  Int @default(0)
  impactModerate Int @default(0)
  impactMinor    Int @default(0)

  // Enhanced analytics fields
  previousScanId String? // Link to previous scan for comparison
  previousScan   Scan?   @relation("ScanHistory", fields: [previousScanId], references: [id])
  nextScans      Scan[]  @relation("ScanHistory")

  scoreImprovement Int? // Change from previous scan
  issuesFixed      Int  @default(0) // Issues resolved since last scan
  newIssues        Int  @default(0) // New issues found since last scan

  // WCAG compliance tracking
  wcagAACompliance  Float? // Percentage of AA compliance (0-100)
  wcagAAACompliance Float? // Percentage of AAA compliance (0-100)

  // Violation categorization for trending
  violationsByRule Json? // { "rule_id": count, ... } for trending analysis

  // Performance & SEO Integration
  performanceScore       Float? // Google PageSpeed Insights score (0-100)
  firstContentfulPaint   Float? // FCP in milliseconds
  largestContentfulPaint Float? // LCP in milliseconds
  cumulativeLayoutShift  Float? // CLS score
  firstInputDelay        Float? // FID in milliseconds
  totalBlockingTime      Float? // TBT in milliseconds

  // SEO correlation data
  seoScore          Float? // Overall SEO health score (0-100)
  metaDescription   String? // Meta description present/quality
  headingStructure  Json? // H1-H6 structure analysis
  altTextCoverage   Float? // Percentage of images with alt text
  linkAccessibility Float? // Percentage of accessible links

  // Legal compliance risk assessment
  adaRiskLevel String? // LOW, MEDIUM, HIGH, CRITICAL

  // Manual audits linked to this scan
  manualAudits     ManualAudit[]
  wcag21Compliance Float? // WCAG 2.1 compliance percentage
  wcag22Compliance Float? // WCAG 2.2 compliance percentage
  complianceGaps   Json? // Specific compliance issues
  legalRiskScore   Float? // Calculated legal risk (0-100)

  // Performance metrics
  scanDuration    Int? // Scan duration in milliseconds
  pageLoadTime    Int? // Page load time in milliseconds
  elementsScanned Int? // Number of elements analyzed

  // Raw scan data
  raw Json?

  // Accessibility Assurance scans
  assuranceScans AssuranceScan[]

  createdAt DateTime @default(now())

  @@index([siteId])
  @@index([pageId])
  @@index([createdAt]) // For historical queries
  @@index([siteId, createdAt]) // For site-specific historical queries
}

enum Plan {
  TRIAL
  STARTER
  PRO
  BUSINESS
}

model Usage {
  id        String   @id @default(cuid())
  userId    String
  period    String // "2025-09"
  pages     Int      @default(0)
  sites     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, period])
}

model Crawl {
  id     String @id @default(cuid())
  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  status   String @default("queued") // queued, running, done, error
  maxPages Int    @default(50)
  maxDepth Int    @default(3)

  pagesQueued Int @default(0)
  pagesDone   Int @default(0)
  pagesError  Int @default(0)

  startedAt  DateTime  @default(now())
  finishedAt DateTime?

  crawlUrls CrawlUrl[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([siteId])
  @@index([status])
}

model CrawlUrl {
  id      String @id @default(cuid())
  crawlId String
  crawl   Crawl  @relation(fields: [crawlId], references: [id], onDelete: Cascade)

  url    String
  depth  Int     @default(0)
  status String  @default("queued") // queued, running, done, error, skipped
  reason String? // Error reason or skip reason

  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@unique([crawlId, url]) // Prevent duplicate URLs in same crawl
  @@index([crawlId, status])
}

model Benchmark {
  id String @id @default(cuid())

  // Industry/category benchmarks
  industry String // e.g., "ecommerce", "healthcare", "education", "government"
  category String? // sub-category if applicable

  // Benchmark scores
  avgScore    Float // Average accessibility score
  avgCritical Float // Average critical issues per page
  avgSerious  Float // Average serious issues per page
  avgModerate Float // Average moderate issues per page
  avgMinor    Float // Average minor issues per page

  // WCAG compliance averages
  avgWcagAA  Float // Average AA compliance percentage
  avgWcagAAA Float // Average AAA compliance percentage

  // Sample size and metadata
  sampleSize  Int // Number of sites/pages in benchmark
  lastUpdated DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([industry, category])
  @@index([industry])
}

model WhiteLabel {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Branding
  companyName String?
  logoUrl     String?
  faviconUrl  String?

  // Colors
  primaryColor   String @default("#3B82F6") // Blue-500
  secondaryColor String @default("#1F2937") // Gray-800
  accentColor    String @default("#10B981") // Green-500

  // Contact Information
  supportEmail String?
  website      String?
  phone        String?

  // Footer Customization
  footerText    String?
  showPoweredBy Boolean @default(true)

  // Domain Settings
  customDomain String?
  subdomain    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Portfolio {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String // Portfolio name (e.g., "Main Sites", "Client Portfolio")
  description String?

  // Portfolio-wide metrics
  totalSites  Int    @default(0)
  avgScore    Float? // Average accessibility score across all sites
  totalIssues Int    @default(0)
  riskScore   Float? // Combined legal/compliance risk

  // Performance correlation
  avgPerformance         Float? // Average performance score
  performanceCorrelation Float? // Correlation between accessibility and performance

  // Portfolio prioritization
  priorityMatrix Json? // Impact/effort matrix data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Portfolio can contain multiple sites
  sites Site[]

  @@index([userId])
}

enum TeamRole {
  ADMIN
  EDITOR
  VIEWER
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model Team {
  id          String  @id @default(cuid())
  name        String
  description String?
  ownerId     String
  owner       User    @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  members TeamMember[]
  invites TeamInvite[]
  sites   Site[]       @relation("TeamSites")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      TeamRole @default(VIEWER)
  invitedBy String?
  inviter   User?    @relation("InvitedByUser", fields: [invitedBy], references: [id], onDelete: SetNull)
  joinedAt  DateTime @default(now())
  createdAt DateTime @default(now())

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model TeamInvite {
  id         String    @id @default(cuid())
  teamId     String
  team       Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  email      String
  role       TeamRole  @default(VIEWER)
  invitedBy  String
  inviter    User      @relation("InvitedBy", fields: [invitedBy], references: [id], onDelete: Cascade)
  token      String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([teamId])
  @@index([email])
}

model Issue {
  id          String        @id @default(cuid())
  scanId      String
  scan        Scan          @relation(fields: [scanId], references: [id], onDelete: Cascade)
  violationId String // Reference to specific violation in scan.raw
  title       String
  description String?
  status      IssueStatus   @default(OPEN)
  priority    IssuePriority @default(MEDIUM)

  assignedToId String?
  assignedTo   User?   @relation("AssignedTo", fields: [assignedToId], references: [id], onDelete: SetNull)
  assignedById String?
  assignedBy   User?   @relation("AssignedBy", fields: [assignedById], references: [id], onDelete: SetNull)
  createdById  String
  createdBy    User    @relation("CreatedBy", fields: [createdById], references: [id], onDelete: Cascade)

  resolvedAt   DateTime?
  resolvedById String?
  resolvedBy   User?     @relation("ResolvedBy", fields: [resolvedById], references: [id], onDelete: SetNull)

  dueDate        DateTime?
  estimatedHours Int?
  actualHours    Int?
  tags           String[]

  comments   IssueComment[]
  activities IssueActivity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([scanId, violationId])
  @@index([scanId])
  @@index([assignedToId])
  @@index([createdById])
  @@index([status])
  @@index([priority])
}

model IssueComment {
  id        String   @id @default(cuid())
  issueId   String
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([issueId])
  @@index([userId])
}

model IssueActivity {
  id        String   @id @default(cuid())
  issueId   String
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action    String // "created", "assigned", "status_changed", "priority_changed", etc.
  oldValue  String?
  newValue  String?
  createdAt DateTime @default(now())

  @@index([issueId])
  @@index([userId])
}

// ============================================
// MANUAL ACCESSIBILITY AUDIT SYSTEM
// ============================================

model ManualAudit {
  id     String @id @default(cuid())
  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Optional link to automated scan for comparison
  scanId String?
  scan   Scan?   @relation(fields: [scanId], references: [id], onDelete: SetNull)

  // Audit metadata
  name        String // e.g., "WCAG 2.1 AA Audit - Homepage"
  description String?
  templateId  String? // Link to audit template used
  template    AuditTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  // Audit status
  status String @default("draft") // draft, in_progress, under_review, completed

  // Assignment
  createdById  String
  createdBy    User    @relation("AuditCreator", fields: [createdById], references: [id], onDelete: Cascade)
  assignedToId String?
  assignedTo   User?   @relation("AuditAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  reviewedById String?
  reviewedBy   User?   @relation("AuditReviewer", fields: [reviewedById], references: [id], onDelete: SetNull)

  // Progress tracking
  totalCriteria     Int @default(0)
  completedCriteria Int @default(0)
  passedCriteria    Int @default(0)
  failedCriteria    Int @default(0)

  // Overall results
  overallScore Float? // 0-100 percentage
  wcagLevel    String? // "A", "AA", "AAA"
  compliant    Boolean @default(false)

  // Timing
  dueDate     DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  reviewedAt  DateTime?

  // Audit items (checklist)
  items       AuditItem[]
  attachments AuditAttachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId])
  @@index([scanId])
  @@index([createdById])
  @@index([assignedToId])
  @@index([status])
}

model AuditTemplate {
  id          String  @id @default(cuid())
  name        String // e.g., "WCAG 2.1 AA Checklist"
  description String?
  category    String // "wcag", "section508", "custom", "industry"
  wcagLevel   String? // "A", "AA", "AAA"

  // Template metadata
  isPublic    Boolean @default(true)
  isDefault   Boolean @default(false)
  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id], onDelete: SetNull)

  // Template criteria
  criteria AuditCriterion[]
  audits   ManualAudit[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([createdById])
}

model AuditCriterion {
  id         String        @id @default(cuid())
  templateId String
  template   AuditTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // Criterion details
  category    String // "keyboard", "screen_reader", "color", "forms", etc.
  subcategory String? // More specific grouping
  title       String // e.g., "All interactive elements are keyboard accessible"
  description String?
  howToTest   String? // Testing instructions

  // WCAG mapping
  wcagCriterion String? // e.g., "1.1.1", "2.1.1"
  wcagLevel     String? // "A", "AA", "AAA"
  wcagUrl       String? // Link to WCAG documentation

  // Importance
  priority String  @default("medium") // critical, high, medium, low
  required Boolean @default(true)

  // Display order
  order Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([templateId])
  @@index([category])
}

model AuditItem {
  id      String      @id @default(cuid())
  auditId String
  audit   ManualAudit @relation(fields: [auditId], references: [id], onDelete: Cascade)

  // Link to template criterion or custom
  criterionId String? // If based on template

  // Item details
  category    String
  subcategory String?
  title       String
  description String?
  howToTest   String?

  // WCAG mapping
  wcagCriterion String?
  wcagLevel     String?
  wcagUrl       String?

  // Test results
  status String  @default("pending") // pending, pass, fail, not_applicable, needs_review
  result String? // Detailed result notes

  // Evidence
  notes           String?
  screenshotUrls  String[] // Array of uploaded screenshots
  elementSelector String? // CSS selector or XPath
  pageUrl         String? // Specific page tested

  // Testing details
  testedById String?
  testedBy   User?     @relation(fields: [testedById], references: [id], onDelete: SetNull)
  testedAt   DateTime?

  // Remediation
  remediationNotes String?
  priority         String  @default("medium")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([auditId])
  @@index([testedById])
  @@index([status])
  @@index([category])
}

model AuditAttachment {
  id      String      @id @default(cuid())
  auditId String
  audit   ManualAudit @relation(fields: [auditId], references: [id], onDelete: Cascade)

  fileName    String
  fileUrl     String
  fileType    String // "screenshot", "document", "video", "other"
  fileSize    Int? // in bytes
  description String?

  uploadedById String
  uploadedBy   User   @relation(fields: [uploadedById], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([auditId])
  @@index([uploadedById])
}

// Blog system
model BlogPost {
  id         String  @id @default(cuid())
  title      String
  slug       String
  content    String  @db.Text
  excerpt    String? @db.Text
  coverImage String?

  // Internationalization
  locale String @default("en") // en, nl, fr, es, pt

  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String[]

  // Organization
  category String
  tags     String[]

  // Publishing
  status      String    @default("draft") // draft, published, archived
  publishedAt DateTime?

  // Author
  authorId   String
  author     User    @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorName String? // Optional custom author name (overrides User.firstName + User.lastName)

  // Analytics
  views Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([slug, locale]) // Slug must be unique per locale
  @@index([authorId])
  @@index([slug])
  @@index([status])
  @@index([category])
  @@index([publishedAt])
  @@index([locale])
}

// Contact form submissions
model ContactMessage {
  id      String @id @default(cuid())
  name    String
  email   String
  message String @db.Text

  // Metadata
  status  String  @default("new") // new, read, replied, archived
  replied Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// SUPPORT TICKET SYSTEM
// ============================================

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
}

enum TicketCategory {
  GENERAL
  BILLING
  TECHNICAL
  FEATURE_REQUEST
  BUG_REPORT
}

model SupportTicket {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  subject  String
  category TicketCategory @default(GENERAL)
  priority TicketPriority @default(MEDIUM)
  status   TicketStatus   @default(OPEN)

  messages SupportTicketMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([createdAt])
  @@index([updatedAt])
}

enum MessageSenderType {
  USER
  ADMIN
}

model SupportTicketMessage {
  id       String        @id @default(cuid())
  ticketId String
  ticket   SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  senderType   MessageSenderType
  senderUserId String?
  senderUser   User?             @relation(fields: [senderUserId], references: [id], onDelete: SetNull)

  message String @db.Text

  createdAt DateTime @default(now())

  @@index([ticketId])
  @@index([senderUserId])
  @@index([createdAt])
}

// ============================================
// ADMIN USER MANAGEMENT
// ============================================

model AdminUserNote {
  id      String @id @default(cuid())
  userId  String
  adminId String
  admin   User?  @relation("AdminNotes", fields: [adminId], references: [id], onDelete: SetNull)
  note    String @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([adminId])
  @@index([createdAt])
}

enum AdminEventType {
  PLAN_CHANGE
  STATUS_CHANGE
  PAYMENT_REFUND
  NOTE_ADDED
  TICKET_CREATED
  TICKET_CLOSED
  CONTACT_CONVERTED
  MANUAL_ACTIVATION
  MANUAL_SUSPENSION
  EMAIL_SENT
}

model UserAdminEvent {
  id          String         @id @default(cuid())
  userId      String
  adminId     String?
  eventType   AdminEventType
  metadata    Json?
  description String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([adminId])
  @@index([eventType])
  @@index([createdAt])
}

// ============================================
// NOTIFICATIONS SYSTEM
// ============================================

enum NotificationType {
  SCAN_COMPLETE
  ISSUE_ASSIGNED
  ISSUE_RESOLVED
  TEAM_INVITE
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  SUBSCRIPTION_EXPIRING
  TRIAL_EXPIRING
  REGRESSION_DETECTED
  ALERT_TRIGGERED
  SYSTEM_ANNOUNCEMENT
}

model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type    NotificationType
  title   String
  message String           @db.Text
  link    String? // Optional link to related resource

  read   Boolean   @default(false)
  readAt DateTime?

  metadata Json? // Additional data (scanId, issueId, etc.)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([userId, read])
  @@index([createdAt])
}

// ============================================
// WEBHOOKS SYSTEM
// ============================================

enum WebhookEvent {
  SCAN_COMPLETED
  SCAN_FAILED
  ISSUE_CREATED
  ISSUE_UPDATED
  ISSUE_RESOLVED
  ALERT_TRIGGERED
  REGRESSION_DETECTED
}

model WebhookEndpoint {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name   String // User-friendly name
  url    String // Webhook endpoint URL
  secret String // Secret for HMAC signature

  events WebhookEvent[] // Events to trigger webhook
  active Boolean        @default(true)

  // Statistics
  lastTriggered DateTime?
  successCount  Int       @default(0)
  failureCount  Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([active])
}

// ============================================
// SYSTEM LOGGING & MONITORING
// ============================================

model ErrorLog {
  id String @id @default(cuid())

  // Error details
  message    String
  stack      String? @db.Text
  level      String  @default("error") // error, warning, critical
  source     String? // API route, component, function name
  statusCode Int?

  // Context
  userId    String?
  userEmail String?
  url       String?
  method    String? // GET, POST, etc
  userAgent String?
  ip        String?

  // Additional data
  metadata Json? // Any additional context as JSON

  resolved   Boolean   @default(false)
  resolvedBy String?
  resolvedAt DateTime?

  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([level])
  @@index([resolved])
  @@index([userId])
}

model ApiLog {
  id String @id @default(cuid())

  // Request details
  method     String // GET, POST, PUT, DELETE, etc
  path       String // API endpoint path
  statusCode Int
  duration   Int // Response time in ms

  // User context
  userId    String?
  userEmail String?
  ip        String?
  userAgent String?

  // Request/Response data (optional, for debugging)
  requestBody  Json? // Sanitized request body
  responseBody Json? // Sanitized response body
  errorMessage String?

  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([path])
  @@index([statusCode])
  @@index([userId])
  @@index([method])
}

model AuditLog {
  id String @id @default(cuid())

  // Action details
  action      String // e.g., "user.created", "subscription.upgraded", "scan.deleted"
  entity      String // User, Site, Scan, etc.
  entityId    String? // ID of the affected entity
  description String // Human-readable description

  // Actor (who performed the action)
  actorId    String?
  actorEmail String?
  actorType  String  @default("user") // user, system, admin, api

  // Context
  ip        String?
  userAgent String?
  metadata  Json? // Additional context data

  // Changes (for update actions)
  oldValues Json? // Previous values
  newValues Json? // New values

  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([action])
  @@index([actorId])
  @@index([entity])
  @@index([entityId])
}

model ScheduledScan {
  id String @id @default(cuid())

  // Ownership
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Schedule configuration
  frequency  String // daily, weekly, monthly
  dayOfWeek  Int? // 0-6 for weekly (0 = Sunday)
  dayOfMonth Int? // 1-31 for monthly
  timeOfDay  String @default("00:00") // HH:MM format

  // Status
  active    Boolean   @default(true)
  lastRunAt DateTime?
  nextRunAt DateTime?

  // Notifications
  emailOnComplete Boolean @default(true)
  emailOnIssues   Boolean @default(true)
  webhookUrl      String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([siteId])
  @@index([active, nextRunAt])
  @@index([nextRunAt])
}

// ============================================
// ADD-ONS SYSTEM (Extra Seats & Scan Packages)
// ============================================

enum AddOnType {
  EXTRA_SEAT // €15/month per seat
  SCAN_PACK_100 // +100 scans, €19/month
  SCAN_PACK_500 // +500 scans, €69/month
  SCAN_PACK_1500 // +1500 scans, €179/month
}

model AddOn {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type AddOnType

  // Mollie integration
  mollieSubscriptionId String? @unique // Each add-on has its own Mollie subscription
  status               String  @default("active") // active, canceled, past_due, inactive

  // Quantity (for seats: number of extra seats, for scans: always 1 package)
  quantity Int @default(1)

  // Billing
  pricePerUnit Decimal @db.Decimal(10, 2) // Price per unit in EUR
  totalPrice   Decimal @db.Decimal(10, 2) // Total monthly price (quantity * pricePerUnit)

  // Lifecycle
  activatedAt DateTime  @default(now())
  canceledAt  DateTime? // When user requested cancellation
  expiresAt   DateTime? // When it actually expires (end of billing period)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, status])
  @@index([type])
  @@index([status])
}

// ============================================
// ACCESSIBILITY ASSURANCE SYSTEM
// ============================================

enum AssuranceTier {
  BASIC         // €9.99/mo - 1 domain
  PRO           // €24.99/mo - 5 domains
  PUBLIC_SECTOR // €49.99/mo - 20 domains
}

enum AssuranceFrequency {
  WEEKLY   // Every 7 days
  BIWEEKLY // Every 14 days
}

enum AssuranceAlertType {
  REGRESSION      // Score dropped below threshold
  SCORE_DROP      // Significant score decrease (even if above threshold)
  CRITICAL_ISSUES // New critical accessibility issues detected
  SCAN_FAILED     // Scheduled scan failed to execute
}

enum AssuranceAlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Accessibility Assurance Subscription
model AssuranceSubscription {
  id     String @id @default(cuid())
  userId String
  user   User   @relation("AssuranceSubscriptions", fields: [userId], references: [id], onDelete: Cascade)

  // Subscription tier
  tier   AssuranceTier @default(BASIC)
  status String        @default("active") // active, canceled, past_due, inactive

  // Mollie integration (separate from main VexNexa subscription)
  mollieSubscriptionId String? @unique
  billingCycle         String  @default("monthly") // monthly, semiannual, annual

  // Pricing
  pricePerMonth Decimal @db.Decimal(10, 2)
  totalPrice    Decimal @db.Decimal(10, 2)

  // Lifecycle
  activatedAt DateTime  @default(now())
  canceledAt  DateTime?
  expiresAt   DateTime?

  // Relations
  domains AssuranceDomain[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, status])
  @@index([tier])
}

// Monitored Domain Configuration
model AssuranceDomain {
  id             String                @id @default(cuid())
  subscriptionId String
  subscription   AssuranceSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  // Domain details
  domain String // e.g., "example.com" or "example.com/specific-page"
  label  String? // User-friendly name (optional)

  // Monitoring configuration
  scanFrequency  AssuranceFrequency @default(WEEKLY)
  scoreThreshold Int                @default(90) // Alert if score drops below this
  active         Boolean            @default(true)
  language       String             @default("en") // Report language: en/nl/fr/es/pt

  // Email configuration (up to 5 recipients)
  emailRecipients String[] // Array of email addresses

  // Scheduling
  dayOfWeek Int    @default(1) // 0-6 for weekly (1 = Monday default)
  timeOfDay String @default("09:00") // HH:MM format

  lastRunAt DateTime?
  nextRunAt DateTime?

  // Relations
  scans   AssuranceScan[]
  reports AssuranceReport[]
  alerts  AssuranceAlert[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([subscriptionId, domain]) // One entry per domain per subscription
  @@index([subscriptionId])
  @@index([active, nextRunAt])
  @@index([nextRunAt])
}

// Assurance Scan Results (linked to regular Scan table)
model AssuranceScan {
  id       String          @id @default(cuid())
  domainId String
  domain   AssuranceDomain @relation(fields: [domainId], references: [id], onDelete: Cascade)

  // Link to actual scan in main Scan table
  scanId String
  scan   Scan   @relation(fields: [scanId], references: [id], onDelete: Cascade)

  // Snapshot metrics (denormalized for fast querying)
  score             Int
  wcagAACompliance  Float?
  wcagAAACompliance Float?
  issuesCount       Int
  impactCritical    Int
  impactSerious     Int
  impactModerate    Int
  impactMinor       Int

  // Regression detection
  previousScanId String?
  previousScan   AssuranceScan?  @relation("ScanHistory", fields: [previousScanId], references: [id])
  nextScans      AssuranceScan[] @relation("ScanHistory")

  scoreChange  Int?     @default(0) // Difference from previous scan
  isRegression Boolean  @default(false) // True if score dropped below threshold

  createdAt DateTime @default(now())

  @@index([domainId])
  @@index([domainId, createdAt])
  @@index([scanId])
  @@index([isRegression])
}

// PDF Report Generation History
model AssuranceReport {
  id       String          @id @default(cuid())
  domainId String
  domain   AssuranceDomain @relation(fields: [domainId], references: [id], onDelete: Cascade)

  // Report metadata
  scanId   String
  pdfUrl   String // Stored in cloud storage (Vercel Blob)
  language String // en/nl/fr/es/pt

  // Content snapshot
  score             Int
  threshold         Int
  trendData         Json // Last 4-8 scans for chart
  wcagAACompliance  Float?
  wcagAAACompliance Float?

  // Delivery tracking
  emailSentTo String[] // Recipients who received this report
  sentAt      DateTime?

  createdAt DateTime @default(now())

  @@index([domainId])
  @@index([domainId, createdAt])
  @@index([scanId])
}

// Alert History (regressions, threshold violations)
model AssuranceAlert {
  id       String          @id @default(cuid())
  domainId String
  domain   AssuranceDomain @relation(fields: [domainId], references: [id], onDelete: Cascade)

  // Alert type and severity
  type     AssuranceAlertType
  severity AssuranceAlertSeverity @default(MEDIUM)

  // Alert details
  title         String
  message       String @db.Text
  currentScore  Int
  threshold     Int?
  previousScore Int?

  // Related scan
  scanId String?

  // Notification tracking
  emailSentTo String[] // Recipients who were notified
  sentAt      DateTime?

  // Resolution
  resolved   Boolean   @default(false)
  resolvedAt DateTime?
  resolvedBy String? // UserId who resolved it

  createdAt DateTime @default(now())

  @@index([domainId])
  @@index([domainId, createdAt])
  @@index([resolved])
  @@index([type])
}
